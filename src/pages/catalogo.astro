---
import MainLayout from '../layouts/MainLayout.astro';
import { productos, obtenerRutaImagen } from '../utils/data';

// En el build estático renderizamos TODO. El filtrado lo hace el navegador.
---

<MainLayout title="Catálogo">
    <div class="catalogo-container container">
        
        <div class="page-header">
            <h1 id="titulo-categoria">Catálogo Completo</h1>
            <p id="contador-productos">Mostrando todos los diseños</p>
        </div>

        <div class="grid-products">
            {productos.map(p => (
                /* AQUÍ ESTÁ EL TRUCO: 
                   El atributo data-categoria guarda el tipo de flor para que JS lo lea.
                */
                <a 
                    href={`/producto/${p.id}`} 
                    class="card-product item-producto" 
                    data-categoria={p.categoria}
                >
                    <div class="card-img">
                        <img src={obtenerRutaImagen(p.id, p.archivo)} alt={p.nombre} loading="lazy"/>
                    </div>
                    <div class="card-body">
                        <h5>{p.nombre}</h5>
                        <span class="price">${p.precio} MXN</span>
                        <span class="badge-cat">{p.categoria}</span>
                    </div>
                </a>
            ))}
        </div>
        
        <div id="no-results" class="empty-msg" style="display: none;">
            <p>No se encontraron productos en esta categoría.</p>
            <button id="btn-reset" class="btn-reset">Ver todo</button>
        </div>

    </div>
</MainLayout>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        // 1. Detectar qué categoría pidió el usuario desde el menú (URL)
        const params = new URLSearchParams(window.location.search);
        const categoriaSeleccionada = params.get('cat'); // Ej: "Ramos"

        // Referencias al DOM
        const items = document.querySelectorAll('.item-producto');
        const titulo = document.getElementById('titulo-categoria');
        const contador = document.getElementById('contador-productos');
        const noResults = document.getElementById('no-results');
        
        let visibles = 0;

        // 2. Función de Filtrado (True/False)
        items.forEach(item => {
            const htmlItem = item as HTMLElement;
            // Obtenemos la categoría real del producto
            const categoriaProducto = htmlItem.getAttribute('data-categoria');

            // Lógica: Si no hay selección, O es "Todos", O coincide exactamente -> MOSTRAR
            if (!categoriaSeleccionada || categoriaSeleccionada === 'Todos' || categoriaSeleccionada === categoriaProducto) {
                htmlItem.style.display = 'flex'; // Mostrar
                visibles++;
            } else {
                htmlItem.style.display = 'none'; // Ocultar
            }
        });

        // 3. Actualizar textos de la interfaz
        if (categoriaSeleccionada && categoriaSeleccionada !== 'Todos') {
            if (titulo) titulo.textContent = categoriaSeleccionada;
            if (contador) contador.textContent = `${visibles} diseños disponibles`;
        } else {
            if (titulo) titulo.textContent = 'Catálogo Completo';
            if (contador) contador.textContent = `${visibles} diseños disponibles`;
        }

        // Manejo de estado vacío
        if (noResults) {
            if (visibles === 0) {
                noResults.style.display = 'block';
            } else {
                noResults.style.display = 'none';
            }
        }

        // Botón de reset dentro del catálogo
        document.getElementById('btn-reset')?.addEventListener('click', () => {
            window.location.href = '/catalogo';
        });
    });
</script>

<style>
    .catalogo-container { padding-top: 2rem; min-height: 80vh; }
    
    .page-header {
        margin-bottom: 2rem; border-bottom: 1px solid #222; padding-bottom: 1rem;
        display: flex; justify-content: space-between; align-items: baseline;
    }
    .page-header h1 { font-size: 1.8rem; color: white; margin: 0; }
    .page-header p { color: #666; margin: 0; }

    .grid-products {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 1rem;
    }
    @media(min-width: 768px) { .grid-products { grid-template-columns: repeat(3, 1fr); } }
    @media(min-width: 1024px) { .grid-products { grid-template-columns: repeat(4, 1fr); } }

    .card-product { text-decoration: none; display: flex; flex-direction: column; gap: 0.5rem; }
    .card-img { aspect-ratio: 4/5; border-radius: 4px; overflow: hidden; background: #222; }
    .card-img img { width: 100%; height: 100%; object-fit: cover; transition: transform 0.3s; }
    
    .card-body h5 { color: #e0e0e0; font-size: 0.95rem; margin: 0; font-weight: 500; }
    .price { color: var(--color-accent); font-weight: 700; font-size: 0.9rem; }
    .badge-cat { font-size: 0.7rem; color: #666; text-transform: uppercase; margin-top: 2px; display: block; }
    
    .empty-msg { text-align: center; padding: 4rem; color: #666; }
    .btn-reset { background: none; border: none; color: var(--color-accent); text-decoration: underline; cursor: pointer; margin-top: 10px; font-size: 1rem; }
</style>