---
import MainLayout from '../layouts/MainLayout.astro';
import { cargarProductos } from '../utils/loader';
import { Image } from 'astro:assets';

const { productos } = cargarProductos();
---

<MainLayout title="Catálogo">
    <div class="catalogo-container container">
        
        <div class="page-header">
            <div>
                <h1 id="titulo-categoria">Colección Completa</h1>
                <p id="contador-productos" style="color:#888; font-size:0.9rem;">Cargando...</p>
            </div>
            
            </div>

        {productos.length > 0 ? (
            <div class="grid-products" id="products-grid">
                {productos.map(p => (
                    <a 
                        href={`/producto/${p.id}`} 
                        class="card-product item-producto" 
                        data-categoria={p.categoria}
                        data-id={p.id}
                    >
                        <div class="card-img">
                            <Image 
                                src={p.imgPrincipal} 
                                alt={p.nombre}
                                width={400} 
                                height={500}
                                format="webp"
                                loading="lazy"
                            />
                            {p.imagenes.length > 1 && (
                                <span class="badge-more">+{p.imagenes.length - 1} fotos</span>
                            )}
                        </div>
                        <div class="card-body">
                            <h5>{p.nombre}</h5>
                            <span class="badge-cat">{p.categoria}</span>
                        </div>
                    </a>
                ))}
            </div>
        ) : (
            <div class="empty-sys">
                <h3>Aún no hay productos cargados</h3>
                <p>Asegúrate de que las fotos estén en <code>src/assets/productos/</code> con el formato sin precio:</p>
                <code>Nombre_ID001_CATEGORIA_01.jpg</code>
            </div>
        )}
        
        <div id="no-results" class="empty-msg" style="display: none;">
            <p>No hay diseños en esta categoría.</p>
            <button id="btn-reset" class="btn-reset">Ver todo</button>
        </div>

    </div>
</MainLayout>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const params = new URLSearchParams(window.location.search);
        const categoriaSeleccionada = params.get('cat');
        
        const grid = document.getElementById('products-grid');
        const items = Array.from(document.querySelectorAll('.item-producto'));
        
        const titulo = document.getElementById('titulo-categoria');
        const contador = document.getElementById('contador-productos');
        const noResults = document.getElementById('no-results');

        function filtrarProductos() {
            let visibles = 0;
            items.forEach(item => {
                const htmlItem = item as HTMLElement;
                const catProd = htmlItem.getAttribute('data-categoria');
                if (!categoriaSeleccionada || categoriaSeleccionada === 'Todos' || categoriaSeleccionada === catProd) {
                    htmlItem.style.display = 'flex';
                    htmlItem.classList.add('is-visible'); 
                    visibles++;
                } else {
                    htmlItem.style.display = 'none';
                    htmlItem.classList.remove('is-visible');
                }
            });

            if (titulo) titulo.textContent = (categoriaSeleccionada && categoriaSeleccionada !== 'Todos') ? categoriaSeleccionada : 'Colección Completa';
            if (contador) contador.textContent = `${visibles} diseños disponibles`;
            if (noResults) noResults.style.display = (visibles === 0 && items.length > 0) ? 'block' : 'none';
            
            // Orden por defecto: ID (Nuevos)
            ordenarPorId();
        }

        function ordenarPorId() {
            // Ordenamos por ID descendente (o ascendente según prefieras)
            items.sort((a, b) => {
                const itemA = a as HTMLElement;
                const itemB = b as HTMLElement;
                const idA = itemA.getAttribute('data-id') || '';
                const idB = itemB.getAttribute('data-id') || '';
                return idA.localeCompare(idB, undefined, { numeric: true });
            });
            items.forEach(item => grid?.appendChild(item));
        }

        document.getElementById('btn-reset')?.addEventListener('click', () => window.location.href = '/catalogo');
        filtrarProductos();
    });
</script>

<style>
    .catalogo-container { padding-top: 2rem; min-height: 80vh; }
    .page-header { margin-bottom: 2rem; border-bottom: 1px solid #222; padding-bottom: 1rem; display: flex; flex-wrap: wrap; justify-content: space-between; align-items: flex-end; gap: 1rem; }
    .page-header h1 { font-size: 1.5rem; color: white; margin: 0; line-height: 1.2; }
    
    .grid-products { display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem; }
    @media(min-width: 768px) { .grid-products { grid-template-columns: repeat(3, 1fr); } }
    
    .card-product { text-decoration: none; display: flex; flex-direction: column; gap: 0.5rem; position: relative; }
    .card-img { aspect-ratio: 4/5; border-radius: 4px; overflow: hidden; background: #222; position: relative; }
    .card-img img { width: 100%; height: 100%; object-fit: cover; display: block; }
    
    .badge-more { position: absolute; bottom: 5px; right: 5px; background: rgba(0,0,0,0.7); color: white; font-size: 0.7rem; padding: 2px 6px; border-radius: 4px; }
    .card-body h5 { color: #e0e0e0; font-size: 0.9rem; margin: 0; font-weight: 500; }
    /* Estilo sin precio */
    .badge-cat { font-size: 0.7rem; color: var(--color-accent); text-transform: uppercase; margin-top: 2px; }
    
    .empty-msg, .empty-sys { text-align: center; padding: 4rem; color: #666; width: 100%; grid-column: 1 / -1; }
    .btn-reset { background: none; border: none; color: var(--color-accent); text-decoration: underline; cursor: pointer; margin-top: 10px; }
    .empty-sys code { display: block; background: #222; padding: 10px; margin-top: 10px; font-size: 0.8rem; word-break: break-all; }
</style>